#include "288A0.h"
#include "29200.h"
#include "2C8F0.h"
#include "graphics.h"
#include "race_session.h"
#include "rand.h"
#include "task_scheduler.h"

ColorData gMenuLightColor = { 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x50, 0x50, 0x00 };
ColorData gMenuAmbientColor = { 0x7F, 0x7F, 0x7F, 0x00, 0x00, 0x00, 0x00, 0x00 };

u8 gStoryMapRareEventTypes[6][10] = {
    { 0x02, 0x03, 0x05, 0x06, 0x08, 0x06, 0x05, 0x03, 0x02, 0x08 },
    { 0x01, 0x02, 0x04, 0x05, 0x08, 0x05, 0x04, 0x02, 0x01, 0x08 },
    { 0x03, 0x04, 0x05, 0x06, 0x08, 0x06, 0x05, 0x04, 0x03, 0x08 },
    { 0x01, 0x02, 0x03, 0x06, 0x07, 0x08, 0x07, 0x06, 0x03, 0x02 },
    { 0x01, 0x02, 0x04, 0x05, 0x06, 0x08, 0x06, 0x05, 0x04, 0x01 },
    { 0x01, 0x03, 0x04, 0x06, 0x07, 0x08, 0x07, 0x06, 0x04, 0x03 },
};

u8 gStoryMapRegularEventTypes[30][8] = {
    { 0x00, 0x02, 0x03, 0x04, 0x05, 0x06, 0x09, 0x07 },
    { 0x00, 0x01, 0x03, 0x04, 0x05, 0x06, 0x08, 0x09 },
    { 0x00, 0x01, 0x02, 0x04, 0x05, 0x06, 0x09, 0x07 },
    { 0x00, 0x01, 0x02, 0x03, 0x05, 0x06, 0x08, 0x07 },
    { 0x00, 0x01, 0x02, 0x03, 0x04, 0x06, 0x09, 0x07 },
    { 0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x08, 0x07 },
    { 0x00, 0x0D, 0x06, 0x02, 0x00, 0x0D, 0x06, 0x02 },
    { 0x00, 0x0D, 0x06, 0x02, 0x00, 0x0D, 0x06, 0x02 },
    { 0x03, 0x06, 0x09, 0x0D, 0x03, 0x06, 0x09, 0x0D },
    { 0x03, 0x06, 0x09, 0x0D, 0x03, 0x06, 0x09, 0x0D },
    { 0x02, 0x0E, 0x0F, 0x07, 0x02, 0x0E, 0x0F, 0x07 },
    { 0x02, 0x0E, 0x0F, 0x07, 0x02, 0x0E, 0x0F, 0x07 },
    { 0x08, 0x0E, 0x04, 0x07, 0x08, 0x0E, 0x04, 0x07 },
    { 0x08, 0x0E, 0x04, 0x07, 0x08, 0x0E, 0x04, 0x07 },
    { 0x01, 0x05, 0x0A, 0x0B, 0x01, 0x05, 0x0A, 0x0B },
    { 0x01, 0x05, 0x0A, 0x0B, 0x01, 0x05, 0x0A, 0x0B },
    { 0x09, 0x0A, 0x0E, 0x0F, 0x09, 0x0A, 0x0E, 0x0F },
    { 0x09, 0x0A, 0x0E, 0x0F, 0x09, 0x0A, 0x0E, 0x0F },
    { 0x0C, 0x02, 0x03, 0x04, 0x0C, 0x02, 0x03, 0x04 },
    { 0x0C, 0x02, 0x03, 0x04, 0x0C, 0x02, 0x03, 0x04 },
    { 0x0D, 0x0E, 0x0F, 0x0D, 0x0E, 0x0F, 0x0D, 0x0E },
    { 0x0F, 0x0D, 0x0E, 0x0F, 0x0D, 0x0E, 0x0F, 0x0D },
    { 0x0D, 0x0E, 0x0F, 0x0D, 0x0E, 0x0F, 0x0D, 0x0E },
    { 0x0F, 0x0D, 0x0E, 0x0F, 0x0D, 0x0E, 0x0F, 0x0D },
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x03, 0x04 },
    { 0x05, 0x06, 0x09, 0x07, 0x00, 0x01, 0x03, 0x04 },
    { 0x05, 0x06, 0x08, 0x09, 0x00, 0x01, 0x02, 0x04 },
    { 0x05, 0x06, 0x09, 0x07, 0x00, 0x01, 0x02, 0x03 },
    { 0x05, 0x06, 0x08, 0x07, 0x00, 0x01, 0x02, 0x03 },
    { 0x04, 0x06, 0x09, 0x07, 0x00, 0x01, 0x02, 0x03 },
};

u8 gStoryMapRegularEventTypesPad[4] = { 0x04, 0x05, 0x08, 0x07 };

extern u16 D_8009ADE0_9B9E0;

typedef struct {
    u8 pad0[0x9];
    u8 unk9;
} GameConfigLocal_288A0;

extern GameConfigLocal_288A0 *D_800AFE8C_A71FC;

void nullRandomEventCallback(void);

typedef struct {
    u8 pad0[0x41C];
    s32 hasRandomEvent;
    u8 regularEventType;
    u8 pad421[0xB];
    u8 rareEventType;
} StoryMapEventState;

typedef struct {
    u8 pad0[0x5C];
    u8 eventTypeIndex;
} RegularEventTask;

typedef struct {
    u8 pad0[0xD4];
    u8 eventTypeIndex;
} RareEventTask;

void initMenuCameraNode(ViewportNode *node, s32 slotIndex, s32 priority, s32 isSecondary) {
    s8 lightSettings[0x20];
    s32 secondaryFlag;

    secondaryFlag = isSecondary & 0xFF;
    if (secondaryFlag == 0) {
        initViewportNode(node, 0, slotIndex & 0xFF, priority & 0xFF, 1);
    } else {
        initViewportNode(node, 0, slotIndex & 0xFF, priority & 0xFF, 0);
    }

    setViewportScale(node, 1.0f, 1.0f);
    setViewportId(node, ((slotIndex & 0xFF) + 1));
    setModelCameraTransform(node, 0, 0, -0x98, -0x70, 0x97, 0x6F);
    func_8006FA0C_7060C(node, 50.0f, 1.3333334f, 10.0f, 4000.0f);
    setViewportFogById(node->id, 0x3D4, 0x3E6, 0x64, 0x64, 0x64);
    func_8006BEDC_6CADC(&lightSettings, 0, 0, 0x200000, 0, 0, 0);
    setViewportTransformById(node->id, &lightSettings);
    setViewportEnvColor(node, 0, 0, 0);
    setViewportFadeValue(node, 0, 0);
    setViewportLightColors(node->id, 1, &gMenuLightColor, &gMenuAmbientColor);
}

INCLUDE_ASM("asm/nonmatchings/288A0", func_80027E04_28A04);

INCLUDE_ASM("asm/nonmatchings/288A0", func_80028074_28C74);

void initStoryMapRandomEvent(u8 *eventTypeOut) {
    StoryMapEventState *state;
    u8 eventTypeIndex;
    u8 randomIndex;
    RegularEventTask *regularTask;
    RareEventTask *rareTask;

    state = getCurrentAllocation();
    state->hasRandomEvent = 0;
    state->regularEventType = 0xFF;

    if ((randA() & 7) == 7) {
        randomIndex = randB();
        *eventTypeOut = gStoryMapRareEventTypes[D_800AFE8C_A71FC->unk9][randomIndex % 10] - 1;
        rareTask = scheduleTask(initStoryMapRareEvent, 0, 0, 0x5B);
        rareTask->eventTypeIndex = *eventTypeOut;
        state->rareEventType = *eventTypeOut;
        goto check_event;
    }

    eventTypeIndex = gStoryMapRegularEventTypes[D_800AFE8C_A71FC->unk9][D_8009ADE0_9B9E0 & 7];
    if (eventTypeIndex != 0) {
        regularTask = scheduleTask(initStoryMapItem, 0, 0, 0x5B);
        regularTask->eventTypeIndex = eventTypeIndex - 1;
        state->regularEventType = eventTypeIndex - 1;
    }

check_event:
    if (eventTypeIndex != 0) {
        state->hasRandomEvent = 1;
        setCallback(nullRandomEventCallback);
    } else {
        terminateCurrentTask();
    }
}

void nullRandomEventCallback(void) {
}
