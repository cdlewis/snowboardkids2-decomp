#include "common.h"
#include "gamestate.h"
#include "task_scheduler.h"

// Stats for character+snowboard combinations
// Each entry contains 6 performance parameters that get scaled/transformed
// into player physics values (speed, acceleration, handling, etc.)
typedef struct {
    /* 0x0 */ u8 param0; // -> unkAA0 (scaled by complex formula)
    /* 0x1 */ u8 param1; // -> unkAC0 (offset +0x19)
    /* 0x2 */ u8 param2; // -> unkAC1 (offset +1)
    /* 0x3 */ u8 param3; // -> unkAB0 (scaled, can be overridden to 0xC000)
    /* 0x4 */ u8 param4; // -> unkAB4 (scaled)
    /* 0x5 */ u8 param5; // -> unkABC (scaled)
} CharacterBoardStats;   // size = 0x6

// Performance stats table: [18 snowboards][9 characters]
CharacterBoardStats D_80093BB0_947B0[18][9] = {
    /* Balance: Level 1 */
    {
     /* Slash  */ { 0x28, 0x32, 0x28, 0x2D, 0x4B, 0x37 },
     /* Nancy  */ { 0x27, 0x3C, 0x23, 0x37, 0x46, 0x46 },
     /* Jam    */ { 0x28, 0x32, 0x26, 0x2D, 0x48, 0x3C },
     /* Linda  */ { 0x29, 0x28, 0x2D, 0x2D, 0x50, 0x2D },
     /* Tommy  */ { 0x2A, 0x28, 0x41, 0x2D, 0x5A, 0x23 },
     /* Wendy  */ { 0x26, 0x41, 0x26, 0x3C, 0x46, 0x50 },
     /* Damien */ { 0x25, 0x4B, 0x41, 0x41, 0x5A, 0x1E },
     /* Coach  */ { 0x29, 0x44, 0x23, 0x3C, 0x41, 0x50 },
     /* Mr Dog */ { 0x2B, 0x32, 0x55, 0x2D, 0x64, 0x0A },
     },
    /* Balance: Level 2 */
    {
     /* Slash  */ { 0x3C, 0x32, 0x28, 0x2D, 0x4B, 0x37 },
     /* Nancy  */ { 0x3B, 0x3C, 0x23, 0x37, 0x46, 0x46 },
     /* Jam    */ { 0x3C, 0x32, 0x26, 0x2D, 0x48, 0x3C },
     /* Linda  */ { 0x3D, 0x28, 0x2D, 0x2D, 0x50, 0x2D },
     /* Tommy  */ { 0x3E, 0x28, 0x41, 0x2D, 0x5A, 0x23 },
     /* Wendy  */ { 0x3A, 0x41, 0x26, 0x3C, 0x46, 0x50 },
     /* Damien */ { 0x39, 0x4B, 0x41, 0x41, 0x5A, 0x1E },
     /* Coach  */ { 0x3D, 0x44, 0x23, 0x3C, 0x41, 0x50 },
     /* Mr Dog */ { 0x3F, 0x32, 0x55, 0x2D, 0x64, 0x0A },
     },
    /* Balance: Level 3 */
    {
     /* Slash  */ { 0x50, 0x32, 0x28, 0x2D, 0x4B, 0x37 },
     /* Nancy  */ { 0x4F, 0x3C, 0x23, 0x37, 0x46, 0x46 },
     /* Jam    */ { 0x50, 0x32, 0x26, 0x2D, 0x48, 0x3C },
     /* Linda  */ { 0x51, 0x28, 0x2D, 0x2D, 0x50, 0x2D },
     /* Tommy  */ { 0x52, 0x28, 0x41, 0x2D, 0x5A, 0x23 },
     /* Wendy  */ { 0x4E, 0x41, 0x26, 0x3C, 0x46, 0x50 },
     /* Damien */ { 0x4D, 0x4B, 0x41, 0x41, 0x5A, 0x1E },
     /* Coach  */ { 0x51, 0x44, 0x23, 0x3C, 0x41, 0x50 },
     /* Mr Dog */ { 0x53, 0x32, 0x55, 0x2D, 0x64, 0x0A },
     },
    /* Trick: Level 1 */
    {
     /* Slash  */ { 0x25, 0x3C, 0x28, 0x41, 0x4B, 0x50 },
     /* Nancy  */ { 0x24, 0x41, 0x23, 0x4B, 0x46, 0x5F },
     /* Jam    */ { 0x25, 0x3C, 0x26, 0x41, 0x48, 0x55 },
     /* Linda  */ { 0x26, 0x32, 0x2D, 0x41, 0x50, 0x46 },
     /* Tommy  */ { 0x27, 0x32, 0x41, 0x41, 0x5A, 0x3C },
     /* Wendy  */ { 0x23, 0x42, 0x23, 0x4C, 0x44, 0x64 },
     /* Damien */ { 0x22, 0x50, 0x41, 0x5A, 0x5A, 0x37 },
     /* Coach  */ { 0x26, 0x4B, 0x23, 0x55, 0x3C, 0x64 },
     /* Mr Dog */ { 0x28, 0x3C, 0x50, 0x41, 0x64, 0x14 },
     },
    /* Trick: Level 2 */
    {
     /* Slash  */ { 0x39, 0x3C, 0x28, 0x41, 0x4B, 0x50 },
     /* Nancy  */ { 0x38, 0x41, 0x23, 0x4B, 0x46, 0x5F },
     /* Jam    */ { 0x39, 0x3C, 0x26, 0x41, 0x48, 0x55 },
     /* Linda  */ { 0x3A, 0x32, 0x2D, 0x41, 0x50, 0x46 },
     /* Tommy  */ { 0x3B, 0x32, 0x41, 0x41, 0x5A, 0x3C },
     /* Wendy  */ { 0x37, 0x42, 0x23, 0x4C, 0x44, 0x64 },
     /* Damien */ { 0x36, 0x50, 0x41, 0x5A, 0x5A, 0x37 },
     /* Coach  */ { 0x3A, 0x4B, 0x23, 0x55, 0x3C, 0x64 },
     /* Mr Dog */ { 0x3C, 0x3C, 0x50, 0x41, 0x64, 0x14 },
     },
    /* Trick: Level 3 */
    {
     /* Slash  */ { 0x4D, 0x3C, 0x28, 0x41, 0x4B, 0x50 },
     /* Nancy  */ { 0x4C, 0x41, 0x23, 0x4B, 0x46, 0x5F },
     /* Jam    */ { 0x4D, 0x3C, 0x26, 0x41, 0x48, 0x55 },
     /* Linda  */ { 0x4E, 0x32, 0x2D, 0x41, 0x50, 0x46 },
     /* Tommy  */ { 0x4F, 0x32, 0x41, 0x41, 0x5A, 0x3C },
     /* Wendy  */ { 0x4B, 0x42, 0x23, 0x4C, 0x44, 0x64 },
     /* Damien */ { 0x4A, 0x50, 0x41, 0x5A, 0x5A, 0x37 },
     /* Coach  */ { 0x4E, 0x4B, 0x23, 0x55, 0x3C, 0x64 },
     /* Mr Dog */ { 0x50, 0x3C, 0x50, 0x41, 0x64, 0x14 },
     },
    /* Speed: Level 1 */
    {
     /* Slash  */ { 0x2B, 0x23, 0x32, 0x25, 0x50, 0x28 },
     /* Nancy  */ { 0x2A, 0x28, 0x2D, 0x2A, 0x4B, 0x37 },
     /* Jam    */ { 0x2B, 0x23, 0x30, 0x25, 0x4D, 0x2D },
     /* Linda  */ { 0x2C, 0x1E, 0x37, 0x23, 0x55, 0x1E },
     /* Tommy  */ { 0x2D, 0x1E, 0x4B, 0x20, 0x5F, 0x14 },
     /* Wendy  */ { 0x29, 0x2D, 0x2D, 0x2D, 0x49, 0x3C },
     /* Damien */ { 0x28, 0x32, 0x4B, 0x37, 0x5F, 0x0F },
     /* Coach  */ { 0x2B, 0x2D, 0x2D, 0x32, 0x46, 0x44 },
     /* Mr Dog */ { 0x2E, 0x23, 0x5F, 0x25, 0x64, 0x00 },
     },
    /* Speed: Level 2 */
    {
     /* Slash  */ { 0x3F, 0x23, 0x32, 0x25, 0x50, 0x28 },
     /* Nancy  */ { 0x3E, 0x28, 0x2D, 0x2A, 0x4B, 0x37 },
     /* Jam    */ { 0x3F, 0x23, 0x30, 0x25, 0x4D, 0x2D },
     /* Linda  */ { 0x40, 0x1E, 0x37, 0x23, 0x55, 0x1E },
     /* Tommy  */ { 0x41, 0x1E, 0x4B, 0x20, 0x5F, 0x14 },
     /* Wendy  */ { 0x3D, 0x2D, 0x2D, 0x2D, 0x49, 0x3C },
     /* Damien */ { 0x3C, 0x32, 0x4B, 0x37, 0x5F, 0x0F },
     /* Coach  */ { 0x3F, 0x2D, 0x2D, 0x32, 0x46, 0x44 },
     /* Mr Dog */ { 0x42, 0x23, 0x5F, 0x25, 0x64, 0x00 },
     },
    /* Speed: Level 3 */
    {
     /* Slash  */ { 0x53, 0x23, 0x32, 0x25, 0x50, 0x28 },
     /* Nancy  */ { 0x52, 0x28, 0x2D, 0x2A, 0x4B, 0x37 },
     /* Jam    */ { 0x53, 0x23, 0x30, 0x25, 0x4D, 0x2D },
     /* Linda  */ { 0x54, 0x1E, 0x37, 0x23, 0x55, 0x1E },
     /* Tommy  */ { 0x55, 0x1E, 0x4B, 0x20, 0x5F, 0x14 },
     /* Wendy  */ { 0x51, 0x2D, 0x2D, 0x2D, 0x49, 0x3C },
     /* Damien */ { 0x50, 0x32, 0x4B, 0x37, 0x5F, 0x0F },
     /* Coach  */ { 0x53, 0x2D, 0x2D, 0x32, 0x46, 0x44 },
     /* Mr Dog */ { 0x56, 0x23, 0x5F, 0x25, 0x64, 0x00 },
     },
    /* Special: Star */
    {
     /* Slash  */ { 0x53, 0x3C, 0x28, 0x41, 0x4B, 0x46 },
     /* Nancy  */ { 0x52, 0x41, 0x23, 0x4B, 0x46, 0x55 },
     /* Jam    */ { 0x53, 0x3C, 0x26, 0x41, 0x48, 0x4B },
     /* Linda  */ { 0x54, 0x32, 0x2D, 0x41, 0x50, 0x3C },
     /* Tommy  */ { 0x55, 0x32, 0x41, 0x41, 0x5A, 0x32 },
     /* Wendy  */ { 0x51, 0x42, 0x23, 0x4C, 0x46, 0x5A },
     /* Damien */ { 0x50, 0x50, 0x41, 0x5A, 0x5A, 0x2D },
     /* Coach  */ { 0x53, 0x4B, 0x23, 0x55, 0x41, 0x5A },
     /* Mr Dog */ { 0x56, 0x3C, 0x50, 0x41, 0x64, 0x14 },
     },
    /* Special: Feather */
    {
     /* Slash  */ { 0x4D, 0x3C, 0x28, 0x41, 0x18, 0x64 },
     /* Nancy  */ { 0x4C, 0x41, 0x23, 0x4B, 0x16, 0x64 },
     /* Jam    */ { 0x4D, 0x3C, 0x26, 0x41, 0x17, 0x64 },
     /* Linda  */ { 0x4E, 0x32, 0x2D, 0x41, 0x1A, 0x64 },
     /* Tommy  */ { 0x4F, 0x32, 0x41, 0x41, 0x1E, 0x64 },
     /* Wendy  */ { 0x4B, 0x42, 0x23, 0x4C, 0x14, 0x64 },
     /* Damien */ { 0x4A, 0x50, 0x41, 0x5A, 0x1E, 0x64 },
     /* Coach  */ { 0x4E, 0x4B, 0x23, 0x55, 0x12, 0x64 },
     /* Mr Dog */ { 0x50, 0x3C, 0x50, 0x41, 0x28, 0x64 },
     },
    /* Special: Ice */
    {
     /* Slash  */ { 0x50, 0x3C, 0x0A, 0x00, 0x4B, 0x37 },
     /* Nancy  */ { 0x4F, 0x3C, 0x0A, 0x00, 0x46, 0x46 },
     /* Jam    */ { 0x50, 0x3C, 0x0A, 0x00, 0x48, 0x3C },
     /* Linda  */ { 0x51, 0x3C, 0x0A, 0x00, 0x50, 0x2D },
     /* Tommy  */ { 0x52, 0x3C, 0x0A, 0x00, 0x5A, 0x23 },
     /* Wendy  */ { 0x4E, 0x3C, 0x0A, 0x00, 0x41, 0x4B },
     /* Damien */ { 0x4D, 0x3C, 0x0A, 0x00, 0x5A, 0x1E },
     /* Coach  */ { 0x51, 0x3C, 0x0A, 0x00, 0x3C, 0x50 },
     /* Mr Dog */ { 0x53, 0x3C, 0x0A, 0x00, 0x64, 0x0A },
     },
    /* Special: Charm */
    {
     /* Slash  */ { 0x50, 0x32, 0x28, 0x2D, 0x4B, 0x37 },
     /* Nancy  */ { 0x4F, 0x3C, 0x23, 0x37, 0x46, 0x46 },
     /* Jam    */ { 0x50, 0x32, 0x26, 0x2D, 0x48, 0x3C },
     /* Linda  */ { 0x51, 0x28, 0x2D, 0x2D, 0x50, 0x2D },
     /* Tommy  */ { 0x52, 0x28, 0x41, 0x2D, 0x5A, 0x23 },
     /* Wendy  */ { 0x4E, 0x41, 0x26, 0x3C, 0x46, 0x50 },
     /* Damien */ { 0x4D, 0x4B, 0x41, 0x41, 0x5A, 0x1E },
     /* Coach  */ { 0x51, 0x44, 0x23, 0x3C, 0x41, 0x50 },
     /* Mr Dog */ { 0x53, 0x32, 0x55, 0x2D, 0x64, 0x0A },
     },
    /* Special: Poverty */
    {
     /* Slash  */ { 0x28, 0x32, 0x28, 0x2D, 0x4B, 0x37 },
     /* Nancy  */ { 0x27, 0x3C, 0x23, 0x37, 0x46, 0x46 },
     /* Jam    */ { 0x28, 0x32, 0x26, 0x2D, 0x48, 0x3C },
     /* Linda  */ { 0x29, 0x28, 0x2D, 0x2D, 0x50, 0x2D },
     /* Tommy  */ { 0x2A, 0x28, 0x41, 0x2D, 0x5A, 0x23 },
     /* Wendy  */ { 0x26, 0x41, 0x26, 0x3C, 0x46, 0x50 },
     /* Damien */ { 0x64, 0x46, 0x23, 0x50, 0x55, 0x1E },
     /* Coach  */ { 0x29, 0x44, 0x23, 0x3C, 0x41, 0x50 },
     /* Mr Dog */ { 0x2B, 0x32, 0x55, 0x2D, 0x64, 0x0A },
     },
    /* Special: Rich */
    {
     /* Slash  */ { 0x50, 0x32, 0x28, 0x2D, 0x4B, 0x37 },
     /* Nancy  */ { 0x4F, 0x3C, 0x23, 0x37, 0x46, 0x46 },
     /* Jam    */ { 0x50, 0x32, 0x26, 0x2D, 0x48, 0x3C },
     /* Linda  */ { 0x51, 0x28, 0x2D, 0x2D, 0x50, 0x2D },
     /* Tommy  */ { 0x52, 0x28, 0x41, 0x2D, 0x5A, 0x23 },
     /* Wendy  */ { 0x4E, 0x41, 0x26, 0x3C, 0x46, 0x50 },
     /* Damien */ { 0x4D, 0x4B, 0x41, 0x41, 0x5A, 0x1E },
     /* Coach  */ { 0x51, 0x44, 0x23, 0x3C, 0x41, 0x50 },
     /* Mr Dog */ { 0x53, 0x32, 0x55, 0x2D, 0x64, 0x0A },
     },
    /* Special: Ninja */
    {
     /* Slash  */ { 0x08, 0x3C, 0x28, 0x41, 0x4B, 0x50 },
     /* Nancy  */ { 0x07, 0x41, 0x23, 0x4B, 0x46, 0x5F },
     /* Jam    */ { 0x08, 0x3C, 0x26, 0x41, 0x48, 0x55 },
     /* Linda  */ { 0x09, 0x32, 0x2D, 0x41, 0x50, 0x46 },
     /* Tommy  */ { 0x0A, 0x32, 0x41, 0x41, 0x5A, 0x3C },
     /* Wendy  */ { 0x06, 0x42, 0x23, 0x4C, 0x44, 0x64 },
     /* Damien */ { 0x05, 0x50, 0x41, 0x5A, 0x5A, 0x37 },
     /* Coach  */ { 0x09, 0x4B, 0x23, 0x55, 0x3C, 0x64 },
     /* Mr Dog */ { 0x0C, 0x3C, 0x50, 0x41, 0x64, 0x14 },
     },
    /* Special: High-Tech */
    {
     /* Slash  */ { 0x50, 0x32, 0x28, 0x2D, 0x4B, 0x37 },
     /* Nancy  */ { 0x4F, 0x3C, 0x23, 0x37, 0x46, 0x46 },
     /* Jam    */ { 0x50, 0x32, 0x26, 0x2D, 0x48, 0x3C },
     /* Linda  */ { 0x51, 0x28, 0x2D, 0x2D, 0x50, 0x2D },
     /* Tommy  */ { 0x52, 0x28, 0x41, 0x2D, 0x5A, 0x23 },
     /* Wendy  */ { 0x4E, 0x41, 0x26, 0x3C, 0x46, 0x50 },
     /* Damien */ { 0x4D, 0x4B, 0x41, 0x41, 0x5A, 0x1E },
     /* Coach  */ { 0x51, 0x44, 0x23, 0x3C, 0x41, 0x50 },
     /* Mr Dog */ { 0x53, 0x32, 0x55, 0x2D, 0x64, 0x0A },
     },
    /* Special: Dragon */
    {
     /* Slash  */ { 0x25, 0x3C, 0x28, 0x41, 0x4B, 0x50 },
     /* Nancy  */ { 0x24, 0x41, 0x23, 0x4B, 0x46, 0x5F },
     /* Jam    */ { 0x25, 0x3C, 0x26, 0x41, 0x48, 0x55 },
     /* Linda  */ { 0x26, 0x32, 0x2D, 0x41, 0x50, 0x46 },
     /* Tommy  */ { 0x27, 0x32, 0x41, 0x41, 0x5A, 0x3C },
     /* Wendy  */ { 0x23, 0x42, 0x23, 0x4C, 0x44, 0x64 },
     /* Damien */ { 0x22, 0x50, 0x41, 0x5A, 0x5A, 0x37 },
     /* Coach  */ { 0x26, 0x4B, 0x23, 0x55, 0x3C, 0x64 },
     /* Mr Dog */ { 0x28, 0x3C, 0x50, 0x41, 0x64, 0x14 },
     },
};

// Default/fallback stats (used in special mode when gameState->unk7A == 0xB)
// 20 bytes total: 1 entry (6 bytes) + 14 bytes padding
struct {
    CharacterBoardStats entry;
    u8 _pad[14];
} D_80093F7C_94B7C = {
    .entry = { 0x56, 0x41, 0x28, 0x48, 0x4B, 0x50 },
};

void func_80058690_59290(Player *player) {
    GameState *gameState;
    CharacterBoardStats *boardStats;
    u8 charId;
    u8 val;
    s32 temp;
    s32 temp2;

    gameState = (GameState *)getCurrentAllocation();

    if (gameState->unk7A == 0xB) {
        // Special mode: use default stats
        boardStats = &D_80093F7C_94B7C.entry;
        charId = 0;
    } else {
        // Normal mode: unkBBB = snowboard (0-17), unkBB9 = character (0-8)
        boardStats = D_80093BB0_947B0[player->unkBBB];
        charId = player->unkBB9;
    }

    val = boardStats[charId].param0;

    // All this work for val * 353894
    temp = val * 3;
    temp = temp << 7;
    temp = temp - val;
    temp2 = temp << 3;
    temp2 = temp2 - temp;
    temp = temp2 << 5;
    temp2 = temp2 + temp;
    temp2 = temp2 << 2;
    temp2 = temp2 + val;
    temp2 = temp2 + val;

    player->unkAA0 = (temp2 / 100) + 0xEB333;

    player->unkAC0 = boardStats[charId].param1 + 0x19;
    player->unkAC1 = boardStats[charId].param2 + 1;

    temp = boardStats[charId].param3 << 15;
    player->unkAB0 = (temp / 100) + 0x1000;

    if (player->unkBC7 != 0) {
        player->unkAB0 = 0xC000;
    }

    temp = boardStats[charId].param4 << 14;
    player->unkAB4 = (temp / 100) + 0x3000;

    temp = boardStats[charId].param5 << 17;
    player->unkABC = (temp / 100) + 0x28000;
}

s32 func_80058804_59404(s32 characterId, s32 snowboardId) {
    void *allocation;
    CharacterBoardStats *boardStats;
    s32 value;
    s32 temp;
    s32 temp2;

    allocation = getCurrentAllocation();

    if (*(u8 *)((u8 *)allocation + 0x7A) == 0xB) {
        // Special mode: use default stats
        boardStats = &D_80093F7C_94B7C.entry;
        characterId = 0;
    } else {
        // Normal mode
        boardStats = D_80093BB0_947B0[snowboardId];
    }

    value = boardStats[characterId].param0;

    // All this work for val * 353894
    temp = value * 3;
    temp = temp << 7;
    temp = temp - value;
    temp2 = temp << 3;
    temp2 = temp2 - temp;
    temp = temp2 << 5;
    temp2 = temp2 + temp;
    temp2 = temp2 << 2;
    temp2 = temp2 + value;
    temp2 = temp2 + value;

    return (temp2 / 100) + 0xEB333;
}
